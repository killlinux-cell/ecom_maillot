{% extends 'dashboard/base.html' %}

{% block title %}Analyses et Rapports - Dashboard{% endblock %}
{% block page_title %}Analyses et Rapports{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-md-8">
        <h2><i class="fas fa-chart-line"></i> Analyses et Rapports</h2>
        <p class="text-muted">Analysez les performances de votre boutique de maillots</p>
    </div>
    <div class="col-md-4 text-end">
        <div class="btn-group" role="group">
            <button type="button" class="btn btn-outline-primary" onclick="exportData('pdf')">
                <i class="fas fa-file-pdf"></i> PDF
            </button>
            <button type="button" class="btn btn-outline-primary" onclick="exportData('excel')">
                <i class="fas fa-file-excel"></i> Excel
            </button>
        </div>
    </div>
</div>

<!-- Statistiques générales -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card stat-card text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h3>{{ monthly_sales|length }}</h3>
                <p class="mb-0">Mois analysés</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-secondary text-white">
            <div class="card-body text-center">
                <i class="fas fa-tshirt fa-2x mb-2"></i>
                <h3>{{ top_products|length }}</h3>
                <p class="mb-0">Top Produits</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-users fa-2x mb-2"></i>
                <h3>{{ team_stats|length }}</h3>
                <p class="mb-0">Équipes</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card stat-card-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-calendar fa-2x mb-2"></i>
                <h3>{{ monthly_sales.0.month|default:"N/A" }}</h3>
                <p class="mb-0">Mois actuel</p>
            </div>
        </div>
    </div>
</div>
    
<!-- Graphiques des ventes -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-area"></i> Évolution des Ventes Mensuelles</h5>
            </div>
            <div class="card-body">
                <canvas id="salesChart" height="100"></canvas>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-pie"></i> Répartition des Ventes</h5>
            </div>
            <div class="card-body">
                <canvas id="salesPieChart" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Top produits et équipes -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-trophy"></i> Top 10 des Produits les Plus Vendus</h5>
            </div>
            <div class="card-body">
                {% if top_products %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Produit</th>
                                <th>Vendus</th>
                                <th>Revenus</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for product in top_products %}
                            <tr>
                                <td>
                                    {% if forloop.counter == 1 %}
                                        <i class="fas fa-medal text-warning"></i>
                                    {% elif forloop.counter == 2 %}
                                        <i class="fas fa-medal text-secondary"></i>
                                    {% elif forloop.counter == 3 %}
                                        <i class="fas fa-medal text-danger"></i>
                                    {% else %}
                                        <span class="badge bg-primary">{{ forloop.counter }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <strong>{{ product.product_name }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ product.total_sold }}</span>
                                </td>
                                <td>
                                    <strong>{{ product.total_revenue|default:0|floatformat:0 }} FCFA</strong>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-chart-bar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Aucune donnée de vente disponible</p>
                </div>
                {% endif %}
        </div>
    </div>
</div>

    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-users"></i> Performance des Équipes</h5>
            </div>
            <div class="card-body">
                {% if team_stats %}
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Équipe</th>
                                <th>Pays</th>
                                <th>Produits</th>
                                <th>Ventes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for team in team_stats %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        {% if team.logo %}
                                            <img src="{{ team.logo.url }}" alt="{{ team.name }}" 
                                                 class="rounded me-2" style="width: 24px; height: 24px; object-fit: cover;">
                                        {% endif %}
                                        <strong>{{ team.name }}</strong>
                                    </div>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ team.country }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ team.product_count }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-success">{{ team.total_sales|default:0 }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Aucune donnée d'équipe disponible</p>
                </div>
                {% endif %}
            </div>
            </div>
        </div>
    </div>
    
<!-- Détails mensuels -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-calendar-alt"></i> Détails Mensuels</h5>
            </div>
            <div class="card-body">
                {% if monthly_sales %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Mois</th>
                                <th>Commandes</th>
                                <th>Revenus (FCFA)</th>
                                <th>Moyenne par commande</th>
                                <th>Tendance</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month_data in monthly_sales %}
                            <tr>
                                <td>
                                    <strong>{{ month_data.month }}</strong>
                                </td>
                                <td>
                                    <span class="badge bg-primary">{{ month_data.orders }}</span>
                                </td>
                                <td>
                                    <strong>{{ month_data.revenue|floatformat:0 }} FCFA</strong>
                                </td>
                                <td>
                                    {% if month_data.orders > 0 %}
                                        {{ month_data.revenue|floatformat:0 }} FCFA
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>
                                    {% if forloop.counter > 1 %}
                                        {% if month_data.revenue > 0 %}
                                            <span class="text-success"><i class="fas fa-arrow-up"></i> +{{ month_data.revenue|floatformat:0 }} FCFA</span>
                                        {% elif month_data.revenue < 0 %}
                                            <span class="text-danger"><i class="fas fa-arrow-down"></i> {{ month_data.revenue|floatformat:0 }} FCFA</span>
                                        {% else %}
                                            <span class="text-muted"><i class="fas fa-minus"></i> Stable</span>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-calendar fa-2x text-muted mb-2"></i>
                    <p class="text-muted">Aucune donnée mensuelle disponible</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
// Graphique des ventes mensuelles
document.addEventListener('DOMContentLoaded', function() {
    const salesCtx = document.getElementById('salesChart').getContext('2d');
    const pieCtx = document.getElementById('salesPieChart').getContext('2d');
    
    // Données pour le graphique des ventes
    const monthlyData = {{ monthly_sales|safe }};
    const labels = monthlyData.map(item => item.month);
    const revenues = monthlyData.map(item => parseFloat(item.revenue));
    const orders = monthlyData.map(item => item.orders);
    
    // Graphique des ventes
    new Chart(salesCtx, {
    type: 'line',
    data: {
            labels: labels,
        datasets: [{
                label: 'Revenus (FCFA)',
                data: revenues,
                borderColor: '#667eea',
                backgroundColor: 'rgba(102, 126, 234, 0.1)',
            tension: 0.4,
            fill: true
            }, {
                label: 'Nombre de commandes',
                data: orders,
                borderColor: '#f093fb',
                backgroundColor: 'rgba(240, 147, 251, 0.1)',
                tension: 0.4,
                yAxisID: 'y1'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
            scales: {
                y: {
                    type: 'linear',
                    display: true,
                    position: 'left',
                    title: {
                        display: true,
                        text: 'Revenus (FCFA)'
                    }
                },
                y1: {
                    type: 'linear',
                    display: true,
                    position: 'right',
                    title: {
                        display: true,
                        text: 'Commandes'
                    },
                    grid: {
                        drawOnChartArea: false,
                    },
                }
            },
        plugins: {
            legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Évolution des ventes mensuelles'
            }
        }
    }
});

    // Graphique circulaire des revenus
    const totalRevenue = revenues.reduce((a, b) => a + b, 0);
    const revenuePercentages = revenues.map(rev => ((rev / totalRevenue) * 100).toFixed(1));
    
    new Chart(pieCtx, {
        type: 'doughnut',
    data: {
            labels: labels,
        datasets: [{
                data: revenuePercentages,
                backgroundColor: [
                    '#667eea',
                    '#764ba2',
                    '#f093fb',
                    '#f5576c',
                    '#4facfe',
                    '#00f2fe',
                    '#43e97b',
                    '#38f9d7',
                    '#fa709a',
                    '#fee140',
                    '#a8edea',
                    '#fed6e3'
                ],
                borderWidth: 2,
                borderColor: '#fff'
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const label = context.label || '';
                            const value = context.parsed;
                            const revenue = revenues[context.dataIndex];
                            return `${label}: ${value}% (${revenue.toLocaleString()} FCFA)`;
                    }
                }
            }
        }
    }
});
});

// Fonction d'export des données
function exportData(format) {
    if (format === 'pdf') {
        alert('Export PDF - Fonctionnalité à implémenter');
    } else if (format === 'excel') {
        alert('Export Excel - Fonctionnalité à implémenter');
    }
}

// Mise à jour automatique des données (toutes les 5 minutes)
setInterval(function() {
    // Ici vous pouvez ajouter une requête AJAX pour rafraîchir les données
    console.log('Actualisation des données...');
}, 300000);
</script>
{% endblock %}
