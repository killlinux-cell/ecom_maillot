{% extends 'base.html' %}

{% block title %}Commande {{ order.order_number }} - Maillots de Football{% endblock %}

{% block content %}
<div class="container py-5">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-shopping-bag me-2"></i>Commande {{ order.order_number }}</h1>
                <div>
                    {% if user.is_staff or user.is_superuser %}
                        <span class="badge bg-info me-2">Vue Admin</span>
                    {% endif %}
                    <a href="{% url 'orders:order_list' %}" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Retour aux commandes
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row">
        <!-- Informations de la commande -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Détails de la commande</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Statut de la commande</h6>
                            <span class="badge bg-{% if order.status == 'pending' %}warning{% elif order.status == 'processing' %}info{% elif order.status == 'shipped' %}primary{% elif order.status == 'delivered' %}success{% elif order.status == 'cancelled' %}danger{% else %}secondary{% endif %} fs-6">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="col-md-6">
                            <h6>Statut du paiement</h6>
                            <span class="badge bg-{% if order.payment_status == 'paid' %}success{% elif order.payment_status == 'pending' %}warning{% elif order.payment_status == 'failed' %}danger{% else %}secondary{% endif %} fs-6">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                    </div>
                    
                    <hr>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Date de commande</h6>
                            <p>{{ order.created_at|date:"d/m/Y à H:i" }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Dernière mise à jour</h6>
                            <p>{{ order.updated_at|date:"d/m/Y à H:i" }}</p>
                        </div>
                    </div>
                    
                    {% if order.paid_at %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Date de paiement</h6>
                            <p>{{ order.paid_at|date:"d/m/Y à H:i" }}</p>
                        </div>
                    </div>
                    {% endif %}
                    
                    {% if user.is_staff or user.is_superuser %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Client</h6>
                            <p>{{ order.user.first_name }} {{ order.user.last_name }}</p>
                            <p class="text-muted">{{ order.user.email }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>ID Client</h6>
                            <p>{{ order.user.id }}</p>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Articles de la commande -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Articles commandés</h5>
                </div>
                <div class="card-body">
                    {% for item in order.items.all %}
                    <div class="row align-items-center mb-4 pb-4 border-bottom">
                        <div class="col-md-2">
                            {% if item.product.images.first %}
                                <img src="{{ item.product.images.first.image.url }}" class="img-fluid rounded" alt="{{ item.product.name }}" style="height: 80px; object-fit: cover;">
                            {% else %}
                                <div class="bg-light rounded d-flex align-items-center justify-content-center" style="height: 80px;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                        </div>
                        
                        <div class="col-md-4">
                            <h6 class="mb-1">{{ item.product_name }}</h6>
                            <p class="text-muted mb-1">{{ item.product.team.name }}</p>
                            <span class="badge bg-secondary">Taille: {{ item.size }}</span>
                        </div>
                        
                        <div class="col-md-2 text-center">
                            <span class="text-muted">Quantité: {{ item.quantity }}</span>
                        </div>
                        
                        <div class="col-md-2 text-center">
                            <span class="price">{{ item.price }} FCFA</span>
                        </div>
                        
                        <div class="col-md-2 text-end">
                            <span class="price fw-bold">{{ item.total_price }} FCFA</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <!-- Adresse de livraison -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Adresse de livraison</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Destinataire</h6>
                            <p class="mb-1">{{ order.shipping_address.first_name }} {{ order.shipping_address.last_name }}</p>
                            <p class="mb-1">Tél: {{ order.shipping_address.phone }}</p>
                            <p class="mb-1">Email: {{ order.shipping_address.email }}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Adresse</h6>
                            <p class="mb-1">{{ order.shipping_address.address }}</p>
                            <p class="mb-1">{{ order.shipping_address.postal_code }} {{ order.shipping_address.city }}</p>
                            <p class="mb-1">{{ order.shipping_address.country }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Résumé et actions -->
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Résumé de la commande</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between mb-2">
                        <span>Sous-total ({{ order.get_total_items }} article(s)) :</span>
                        <span>{{ order.subtotal }} FCFA</span>
                    </div>
                    <div class="d-flex justify-content-between mb-2">
                        <span>Frais de livraison :</span>
                        <span>{{ order.shipping_cost }} FCFA</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between fw-bold fs-5">
                        <span>Total :</span>
                        <span class="price">{{ order.total }} FCFA</span>
                    </div>
                </div>
            </div>
            
            <!-- Notes -->
            {% if order.notes %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Notes</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">{{ order.notes }}</p>
                </div>
            </div>
            {% endif %}
            
            <!-- Informations de paiement Wave -->
            {% if order.payment and order.payment.payment_method == 'wave_direct' %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-mobile-alt me-2"></i>Paiement Wave Direct
                    </h5>
                </div>
                <div class="card-body">
                    {% if order.payment.wave_transaction_id %}
                        <div class="alert alert-success">
                            <h6><i class="fas fa-check-circle me-2"></i>ID de transaction soumis</h6>
                            <p class="mb-1"><strong>ID :</strong> {{ order.payment.wave_transaction_id }}</p>
                            <p class="mb-1"><strong>Téléphone :</strong> {{ order.payment.customer_phone }}</p>
                            <p class="mb-0"><strong>Statut :</strong> 
                                {% if order.payment.status == 'completed' %}
                                    <span class="badge bg-success">Validé</span>
                                {% elif order.payment.status == 'pending' %}
                                    <span class="badge bg-warning">En attente de validation</span>
                                {% else %}
                                    <span class="badge bg-secondary">{{ order.payment.get_status_display }}</span>
                                {% endif %}
                            </p>
                        </div>
                        
                        {% if order.payment.status == 'pending' %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <small>Votre ID de transaction a été soumis et sera vérifié par notre équipe. Vous recevrez une notification une fois le paiement validé.</small>
                        </div>
                        {% endif %}
                    {% else %}
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-exclamation-triangle me-2"></i>Paiement en attente</h6>
                            <p class="mb-2">Vous devez effectuer le paiement Wave et soumettre l'ID de transaction.</p>
                            <a href="{% url 'payments:wave_direct_payment' order.id %}" class="btn btn-primary btn-sm">
                                <i class="fas fa-mobile-alt me-2"></i>Effectuer le paiement Wave
                            </a>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if order.can_be_cancelled %}
                        <a href="{% url 'orders:order_cancel' order.id %}" class="btn btn-outline-danger" 
                           onclick="return confirm('Êtes-vous sûr de vouloir annuler cette commande ?')">
                            <i class="fas fa-times me-2"></i>Annuler la commande
                        </a>
                        {% endif %}
                        
                        {% if order.payment_status == 'pending' %}
                            {% if order.payment and order.payment.payment_method == 'wave_direct' and not order.payment.wave_transaction_id %}
                            <a href="{% url 'payments:wave_direct_payment' order.id %}" class="btn btn-primary">
                                <i class="fas fa-mobile-alt me-2"></i>Payer avec Wave
                            </a>
                            {% else %}
                            <a href="{% url 'payments:process_payment' order.id %}" class="btn btn-primary">
                                <i class="fas fa-credit-card me-2"></i>Payer maintenant
                            </a>
                            {% endif %}
                        {% endif %}
                        
                        <a href="{% url 'products:product_list' %}" class="btn btn-outline-primary">
                            <i class="fas fa-shopping-bag me-2"></i>Continuer les achats
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
